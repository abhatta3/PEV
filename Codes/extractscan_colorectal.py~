import os
import os.path

inputevent="/Users/anb013/Validation_of_Modification_Model/Data/Colon_Proteogenomic_Events.txt"
scanf="/Users/anb013/Validation_of_Modification_Model/Data/VU_All_Combined_SPECFDR01.txt"

pep={}
with open(inputevent,"r") as inputfile:
    for line in inputfile:
        if '#' in line:
            continue
        line=line.strip().split('\t')
        pepseq=line[2].translate(None, '1234567890._:-*!@#$?')
        if pep.has_key(pepseq):
            old=pep[pepseq]
            old.append(line[0])
            pep[pepseq]=old
        else:
            pep[pepseq]=[line[0]]
            
    

event_scan={}
with open(scanf,"r") as sf:
    for line in sf:
        if '#' in line:
            continue
        line=line.strip().split('\t')
        pepseq=line[8].translate(None, '1234567890._:-*!@#$?')
        fname=line[0]
        scan=int(line[2])
        if pep.has_key(pepseq):
            pev=pep[pepseq]
            if event_scan.has_key(fname):
                sdic=event_scan[fname]
                sdic[scan]=pev
                event_scan[fname]=sdic
            else:
                sdic={scan:pev}
                event_scan[fname]=sdic
                

soutput=open('/Users/anb013/Validation_of_Modification_Model/Data/extract_spec_on_scan_fixed.mgf',"w")
output=open('/Users/anb013/Validation_of_Modification_Model/Data/Scan_files_fixed.txt',"w")

newscanno=0
#output.write("%s\t%s\t%s\n" %(pep[pepseq],fname,scan))
output.write("#Event\tFile_name\tOriginal_scan_number\tNnew_scan_number\n")            
for fname in event_scan:
    scanlist=event_scan[fname]
    PATH='/data/ccms_research_data/CPTAC/MSSpectra/VU/mgf/'+fname
    flag=0
    if os.path.isfile(PATH) and os.access(PATH, os.R_OK):
        with open(PATH,"r") as mgf:
            scanindex=0
            for line in mgf:
                if 'scan=' in line:
                    if scanlist.has_key(scanindex):
                        pev=event_scan[fname][scanindex]
                        for itm in pev:
                            output.write("%s," %(itm))
                        output.write("%\t%s\t%d\t%d\n" %(fname,scanindex,newscanno))
                        newscanno+=1
                        soutput.write("BEGIN IONS\n")
                        soutput.write(line)
                        flag=1
                    scanindex+=1
                elif flag==1 and 'END IONS' not in line:
                    soutput.write(line)
                elif flag==1 and 'END IONS' in line:
                    soutput.write(line)
                    flag=0
            
        
soutput.close()
output.close()
                
                                
                                
                                

        
